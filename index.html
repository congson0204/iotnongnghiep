<!DOCTYPE html>
<html lang="vi">
<head>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>IFrame b·∫£ng ƒëi·ªÅu khi·ªÉn t∆∞·ªõi c√¢y</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827ee; --text:#e5e7eb; --muted:#94a3b8;
      --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444; --ok:#60a5fa; --ring:#1f2937;
      --humid:#22c55e;
      --bar-bg:#1e293b; --bar-fill:#60a5fa;
    }
    [data-theme="light"]{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#475569;--accent:#16a34a;--ring:#e2e8f0;--bar-bg:#e2e8f0;--bar-fill:#2563eb}
    *{box-sizing:border-box}
 



    body{margin:0;font-family:system-ui,Segoe UI,Roboto; background:var(--bg);color:var(--text);display:flex;flex-direction:column;gap:12px;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between}
    .title{font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    /*
    .grid{display:grid;gap:12px;grid-template-columns:repeat(5,1fr)}
    @media(max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:700px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:480px){.grid{grid-template-columns:1fr}}
    */
 


/* L∆∞·ªõi t·ª± co gi√£n: kh√¥ng b·ªã c·∫Øt c·ªôt tr√™n iFrame h·∫πp */
    .grid{
      display:grid;
      gap:clamp(8px,2vw,12px);
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    /* √âp 1 c·ªôt s·ªõm h∆°n ƒë·ªÉ tr√°nh b·ªã c·∫Øt trong layout mobile c·ªßa E-Ra */
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* NgƒÉn tr√†n ngang g√¢y c·∫Øt c·ªôt/scroll ngang kh√≥ ch·ªãu */
    html, body{ width:100%; overflow-x:hidden; }


 
    .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:14px;position:relative;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.15)}
    .label{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;display:flex;align-items:center;gap:8px}
    .label .icon{font-size:20px}
    .value{font-size:22px;font-weight:700;margin-top:8px;display:flex;align-items:baseline}
    .unit{font-size:14px;color:var(--muted);margin-left:6px}
    .trend{position:absolute;right:10px;top:10px;font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{appearance:none;border:none;cursor:pointer;padding:10px 14px;border-radius:10px;font-weight:600}
    .btn{background:var(--ok);color:#0b1220}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--ring)}
    .btn.danger{background:var(--danger);color:#fff}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--ring);font-size:12px;color:var(--muted)}
    .status-dot{width:8px;height:8px;border-radius:999px;background:var(--accent)}
    .small{font-size:12px;color:var(--muted)}

    /* v√≤ng tr√≤n 0-100% */
    .ring-wrap{width:110px;height:110px;margin-top:6px;position:relative}
    .ring{width:110px;height:110px;display:block}
    .ring-bg{fill:none;stroke:var(--ring);stroke-width:10}
    .ring-fg{fill:none;stroke:var(--humid);stroke-width:10;stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%;stroke-dasharray:339.292;stroke-dashoffset:339.292;transition:stroke-dashoffset .5s ease}
    .ring-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800}
    .ring-center .ring-val{font-size:22px}
    .ring-center .ring-unit{font-size:12px;color:var(--muted);margin-left:4px}
    .flex{display:flex;align-items:center;gap:14px}

    /* progress bar ngang */
    .bar-wrap{width:100%;height:14px;background:var(--bar-bg);border-radius:6px;overflow:hidden;margin-top:6px}
    .bar-fill{height:100%;background:var(--bar-fill);width:0%;transition:width .5s ease}
    /* ===== responsive scale tweaks ===== */
    body{padding:clamp(8px,2vw,16px)}
    .grid{gap:clamp(8px,2vw,12px)}
    .label{font-size:clamp(11px,2.2vw,13px)}
    .label .icon{font-size:clamp(18px,3.8vw,20px)}
    .value{font-size:clamp(18px,4vw,22px)}
    button{padding:clamp(8px,1.8vw,10px) clamp(10px,2.2vw,14px)}
    .ring-wrap,.ring{width:110px;height:110px}
    @media(max-width:700px){.ring-wrap,.ring{width:96px;height:96px}}
    @media(max-width:480px){.ring-wrap,.ring{width:84px;height:84px}}
    @media(max-width:360px){.ring-wrap,.ring{width:72px;height:72px}}


          /* T·ª± co theo n·ªôi dung + safe-area cho iOS */
      html, body { margin:0; padding:0; width:100%; min-height:100%; overflow-x:hidden; }
      body { background: var(--bg); }

      #app{
        padding-top: max(16px, env(safe-area-inset-top));
        padding-bottom: max(16px, env(safe-area-inset-bottom));
        padding-left: max(16px, env(safe-area-inset-left));
        padding-right: max(16px, env(safe-area-inset-right));
        display: flex; flex-direction: column; gap: 12px;
      }
      
  </style>
</head>
<body>
  <div id="app">
  <header>
    <div>
      <div class="title">GI√ÅM S√ÅT V√Ä PH√ÇN T√çCH CH·ªà S·ªê TRONG ƒê·∫§T</div>
      <div class="sub" id="subtitle">Ngu·ªìn d·ªØ li·ªáu: demo c·ª•c b·ªô</div>
    </div>
    <div class="controls">
      <span class="pill"><span class="status-dot" id="connDot"></span><span id="connText">ƒêang ch·∫°y</span></span>
      <span class="pill" id="modeText">Ch·∫ø ƒë·ªô: AUTO</span>
      <button id="refreshBtn" class="btn secondary">‚Üª L√†m m·ªõi</button>
    </div>
  </header>

  <section class="grid">
    <div class="card" data-key="soilTemp">
      <div class="label"><span class="icon">üå°Ô∏è</span> Nhi·ªát ƒë·ªô trong ƒë·∫•t</div>
      <div class="value"><span class="val">--</span><span class="unit">¬∞C</span></div>
      <div class="trend" data-trend></div>
    </div>

    <div class="card" data-key="soilMoisture">
      <div class="label"><span class="icon">üíß</span> ƒê·ªô ·∫©m trong ƒë·∫•t</div>
      <div class="flex">
        <div class="ring-wrap">
          <svg class="ring" viewBox="0 0 120 120">
            <circle class="ring-bg" cx="60" cy="60" r="54"></circle>
            <circle class="ring-fg" cx="60" cy="60" r="54"></circle>
          </svg>
          <div class="ring-center"><span class="ring-val">--</span><span class="ring-unit">%</span></div>
        </div>
        <div class="value" style="margin:0"><span class="val">--</span><span class="unit">%</span></div>
      </div>
      <div class="trend" data-trend></div>
    </div>

    <div class="card" data-key="soilPH">
      <div class="label"><span class="icon">‚öóÔ∏è</span> ƒê·ªô pH</div>
      <div class="value"><span class="val">--</span><span class="unit">pH</span></div>
      <div class="bar-wrap"><div class="bar-fill"></div></div>
      <div class="trend" data-trend></div>
    </div>

    <div class="card" data-key="soilEC">
      <div class="label"><span class="icon">üîå</span> ƒê·ªô d·∫´n ƒëi·ªán DC</div>
      <div class="value"><span class="val">--</span><span class="unit">mS/cm</span></div>
      <div class="trend" data-trend></div>
    </div>

    <div class="card" data-key="phosphorus">
      <div class="label"><span class="icon">üü£</span> Photpho (P)</div>
      <div class="value"><span class="val">--</span><span class="unit">mg/kg</span></div>
      <div class="bar-wrap"><div class="bar-fill"></div></div>
      <div class="trend" data-trend></div>
    </div>

    <div class="card" data-key="nitrogen">
      <div class="label"><span class="icon">üü¢</span> Nito (N)</div>
      <div class="value"><span class="val">--</span><span class="unit">mg/kg</span></div>
      <div class="bar-wrap"><div class="bar-fill"></div></div>
      <div class="trend" data-trend></div>
    </div>

    <div class="card" data-key="potassium">
      <div class="label"><span class="icon">üü°</span> Kali (K)</div>
      <div class="value"><span class="val">--</span><span class="unit">mg/kg</span></div>
      <div class="bar-wrap"><div class="bar-fill"></div></div>
      <div class="trend" data-trend></div>
    </div>

    <div class="card" data-key="airTemp">
      <div class="label"><span class="icon">üå§Ô∏è</span> Nhi·ªát ƒë·ªô kh√¥ng kh√≠</div>
      <div class="value"><span class="val">--</span><span class="unit">¬∞C</span></div>
      <div class="trend" data-trend></div>
    </div>

    <div class="card" data-key="airHumidity">
      <div class="label"><span class="icon">‚òÅÔ∏è</span> ƒê·ªô ·∫©m kh√¥ng kh√≠</div>
      <div class="flex">
        <div class="ring-wrap">
          <svg class="ring" viewBox="0 0 120 120">
            <circle class="ring-bg" cx="60" cy="60" r="54"></circle>
            <circle class="ring-fg" cx="60" cy="60" r="54"></circle>
          </svg>
          <div class="ring-center"><span class="ring-val">--</span><span class="ring-unit">%</span></div>
        </div>
        <div class="value" style="margin:0"><span class="val">--</span><span class="unit">%</span></div>
      </div>
      <div class="trend" data-trend></div>
    </div>

    <div class="card" id="irrigationCard">
      <div class="label"><span class="icon">üöø</span> ƒêi·ªÅu khi·ªÉn t∆∞·ªõi c√¢y</div>
      <div class="value" id="irrigationState">Tr·∫°ng th√°i: <strong>T·∫ÆT</strong></div>
      <div class="controls" style="margin-top:8px">
        <button class="btn" id="toggleIrrigation">B·∫≠t t∆∞·ªõi</button>
        <button class="btn secondary" id="pulseIrrigation">Nh√°y t∆∞·ªõi 10s</button>
        <button class="btn danger" id="stopIrrigation">T·∫Øt t∆∞·ªõi</button>
      </div>
      <div class="small" id="lastAction">‚Äî</div>
    </div>
  </section>
  </div>
  <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
  <script>
    const fields=['soilTemp','soilMoisture','soilPH','soilEC','phosphorus','nitrogen','potassium','airTemp','airHumidity'];
    const units={soilTemp:'¬∞C',soilMoisture:'%',soilPH:'pH',soilEC:'mS/cm',phosphorus:'mg/kg',nitrogen:'mg/kg',potassium:'mg/kg',airTemp:'¬∞C',airHumidity:'%'};
    const CIRCUM=339.292;
    let last={};

    function clamp01(x){return Math.max(0, Math.min(1, x))}

    function updateRing(card, percent){
      const fg=card.querySelector('.ring-fg');
      const txt=card.querySelector('.ring-val');
      if(!fg||!txt)return;
      const p=isFinite(percent)?Math.round(percent):0;
      const t=clamp01(p/100);
      fg.style.strokeDashoffset=String(CIRCUM*(1-t));
      txt.textContent=isFinite(percent)?p:'--';
    }

    function updateBar(card,val,max){
      const bar=card.querySelector('.bar-fill');
      if(!bar)return;
      const percent=clamp01(val/max)*100;
      bar.style.width=percent+'%';
    }

    function updateCard(k,v){
      const c=document.querySelector(`[data-key="${k}"]`); if(!c)return;
      const ve=c.querySelector('.val'); const te=c.querySelector('[data-trend]'); const prev=last[k];
      ve.textContent=(v??'--'); if(units[k]) c.querySelector('.unit').textContent=units[k];
      if(typeof prev==='number'&&typeof v==='number'){const d=Math.round((v-prev)*100)/100;te.textContent=d===0?'‚Äî':(d>0?`‚Üë +${d}`:`‚Üì ${d}`);te.style.color=d>0?'var(--ok)':'var(--warn)'}
      last[k]=typeof v==='number'?v:prev;
      if(k==='soilMoisture'||k==='airHumidity') updateRing(c,Number(v));
      if(['phosphorus','nitrogen','potassium'].includes(k)) updateBar(c,Number(v),200);
      if(k==='soilPH') updateBar(c,Number(v),14);
    }

    //function makeDemo(){const r=(a,b)=>+(a+Math.random()*(b-a)).toFixed(2);return{soilTemp:r(18,30),soilMoisture:r(20,60),soilPH:r(5.8,7.2),soilEC:r(0.5,2),phosphorus:r(10,40),nitrogen:r(20,60),potassium:r(80,200),airTemp:r(22,35),airHumidity:r(40,85),irrigationOn:Math.random()<0.3,mode:'AUTO'}}

    function applyPayload(p){fields.forEach(k=>{if(p&&p[k]!==undefined)updateCard(k,p[k])});if(p&&typeof p.irrigationOn==='boolean')setIrrigationState(p.irrigationOn)}

    const irrigationStateEl=document.getElementById('irrigationState');const lastActionEl=document.getElementById('lastAction');let irrigationOn=false;
    function setIrrigationState(on){irrigationOn=!!on;irrigationStateEl.innerHTML=`Tr·∫°ng th√°i: <strong>${on?'B·∫¨T':'T·∫ÆT'}</strong>`;document.getElementById('toggleIrrigation').textContent=on?'T·∫Øt t∆∞·ªõi':'B·∫≠t t∆∞·ªõi'}
    document.getElementById('toggleIrrigation').onclick=()=>{setIrrigationState(!irrigationOn);lastActionEl.textContent='ƒê·ªïi tr·∫°ng th√°i'}
    document.getElementById('pulseIrrigation').onclick=()=>{lastActionEl.textContent='Nh√°y t∆∞·ªõi 10s'}
    document.getElementById('stopIrrigation').onclick=()=>{setIrrigationState(false);lastActionEl.textContent='D·ª´ng t∆∞·ªõi'}

    //applyPayload(makeDemo());
    //TEST ƒê·∫®Y  
/*    
applyPayload({
  soilTemp: 26.4,
  soilMoisture: 52,
  soilPH: 6.5,
  soilEC: 1.2,
  phosphorus: 28,
  nitrogen: 45,
  potassium: 150,
  airTemp: 30.1,
  airHumidity: 68
});
  */   
/// TEST ERA

const eraWidget = new EraWidget();

 let configsoilTemp = null, configsoilMoisture  = null,configsoilPH=null,configsoilEC=null,configphosphorus=null,confignitrogen=null,  configpotassium=null, configairTemp=null, configairHumidity=null, actions = [];
eraWidget.init({
      needRealtimeConfigs: true,         /* C·∫ßn gi√° tr·ªã hi·ªán th·ªùi */
      needHistoryConfigs: true,          /* C·∫ßn gi√° tr·ªã l·ªãch s·ª≠ */
      needActions: true,                 /* C·∫ßn c√°c h√†nh ƒë·ªông (v√≠ d·ª• B·∫≠t/T·∫Øt ƒë√®n) */
      maxRealtimeConfigsCount: 12,        /* S·ªë l∆∞·ª£ng t·ªëi ƒëa gi√° tr·ªã hi·ªán th·ªùi */
      maxHistoryConfigsCount: 12,         /* S·ªë l∆∞·ª£ng t·ªëi ƒëa gi√° tr·ªã l·ªãch s·ª≠ */
      maxActionsCount: 2,                /* S·ªë l∆∞·ª£ng t·ªëi ƒëa c√°c h√†nh ƒë·ªông c√≥ th·ªÉ k√≠ch ho·∫°t */
      minRealtimeConfigsCount: 0,        /* S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu gi√° tr·ªã hi·ªán th·ªùi */
      minHistoryConfigsCount: 0,         /* S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu gi√° tr·ªã l·ªãch s·ª≠ */
      minActionsCount: 0,                /* S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu h√†nh ƒë·ªông */
      mobileHeight:500,
  
     
     onConfiguration: (configuration) => {

        // L∆∞u c√°c c·∫•u h√¨nh khi nh·∫≠n ƒë∆∞·ª£c t·ª´ widget
        configsoilTemp = configuration.realtime_configs[0];  // L∆∞u c·∫•u h√¨nh nhi·ªát ƒë·ªô ƒê·∫§T
        configsoilMoisture = configuration.realtime_configs[1];  // L∆∞u c·∫•u h√¨nh ƒë·ªô ·∫©m ƒê·∫§T
        configsoilPH = configuration.realtime_configs[2];  // L∆∞u c·∫•u h√¨nh PH
        configsoilEC = configuration.realtime_configs[3];  // L∆∞u c·∫•u h√¨nh ƒë√®n LED
        configphosphorus = configuration.realtime_configs[4];  // L∆∞u c·∫•u h√¨nh ƒë√®n LED
        confignitrogen = configuration.realtime_configs[5];  // L∆∞u c·∫•u h√¨nh ƒë√®n LED
        configpotassium = configuration.realtime_configs[6];  // L∆∞u c·∫•u h√¨nh ƒë√®n LED
        configairTemp = configuration.realtime_configs[7];  // L∆∞u c·∫•u h√¨nh ƒë√®n LED
        configairHumidity = configuration.realtime_configs[8];  // L∆∞u c·∫•u h√¨nh ƒë√®n LED
        action = configuration.actions;  // L∆∞u c√°c h√†nh ƒë·ªông ƒëi·ªÅu khi·ªÉn
      },
    onValues: (values = {}) => {
  // helper: l·∫•y gi√° tr·ªã an to√†n theo 1 config
  const pick = (cfg) => {
    if (!cfg || !cfg.id) return undefined;
    const slot = values[cfg.id];
    if (!slot) return undefined;
    let v = slot.value;
    // √âp s·ªë n·∫øu l√† chu·ªói s·ªë
    if (typeof v === 'string' && v.trim() !== '' && !isNaN(Number(v))) v = Number(v);
    return v;
  };

  // Gom payload theo ƒë√∫ng 9 key UI b·∫°n ƒëang d√πng
  const payload = {
    soilTemp:     pick(configsoilTemp),
    soilMoisture: pick(configsoilMoisture),
    soilPH:       pick(configsoilPH),
    soilEC:       pick(configsoilEC),
    phosphorus:   pick(configphosphorus),
    nitrogen:     pick(confignitrogen),
    potassium:    pick(configpotassium),
    airTemp:      pick(configairTemp),
    airHumidity:  pick(configairHumidity)
  };

  // ƒê·∫©y v√†o UI (applyPayload t·ª± b·ªè qua c√°c key undefined)
  applyPayload(payload);
},
});

  eraWidget.ready();       // b√°o ƒë√£ s·∫µn s√†ng ƒë·ªÉ E-Ra b·∫Øt ƒë·∫ßu g·ª≠i d·ªØ li·ªáu




    /*
    // === Auto-height for parent page (iframe) ===
    function postHeight(){
      const h = document.documentElement.scrollHeight;
      if (window.parent !== window) {
        window.parent.postMessage({ type:'iframe-height', height:h }, '*');
      }
    }
    new ResizeObserver(postHeight).observe(document.documentElement);
    window.addEventListener('load', postHeight);
    window.addEventListener('resize', postHeight);
*/



  </script>





</body>
</html>

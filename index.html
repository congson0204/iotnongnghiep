<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>IFrame b·∫£ng ƒëi·ªÅu khi·ªÉn t∆∞·ªõi c√¢y</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827ee; --text:#e5e7eb; --muted:#94a3b8;
      --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444; --ok:#60a5fa; --ring:#1f2937;
      --humid:#22c55e; --bar-bg:#1e293b; --bar-fill:#60a5fa;
    }
    [data-theme="light"]{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#475569;--accent:#16a34a;--ring:#e2e8f0;--bar-bg:#e2e8f0;--bar-fill:#2563eb}
    *{box-sizing:border-box}

    html, body { margin:0; padding:0; width:100%; min-height:100%; overflow-x:hidden; }
    body { background: transparent; font-family:system-ui, Segoe UI, Roboto; color:var(--text); }

    .shell{
      max-width:1180px;
      margin:0 auto;
      padding-top:max(12px, env(safe-area-inset-top));
      padding-bottom:max(12px, env(safe-area-inset-bottom));
      padding-left:max(12px, env(safe-area-inset-left));
      padding-right:max(12px, env(safe-area-inset-right));
    }

    .panel-sizer{ position:relative; height:auto; }

    .panel{
      width:1180px; /* DESIGN WIDTH */
      margin:0 auto;
      background:#0b1220;
      border:1px solid var(--ring);
      border-radius:16px;
      padding:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
      transform-origin: top center;
    }

    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:4px 4px 0}
    .title{font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--ring);font-size:12px;color:var(--muted)}
    .status-dot{width:8px;height:8px;border-radius:999px;background:var(--accent)}
    button{appearance:none;border:none;cursor:pointer;padding:10px 14px;border-radius:10px;font-weight:600}
    .btn{background:var(--ok);color:#0b1220}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--ring)}
    .btn.danger{background:var(--danger);color:#fff}

    .grid{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}

    .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:14px;position:relative;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.15)}
    .label{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;display:flex;align-items:center;gap:8px}
    .label .icon{font-size:20px}
    .value{font-size:22px;font-weight:700;margin-top:8px;display:flex;align-items:baseline}
    .unit{font-size:14px;color:var(--muted);margin-left:6px}
    .trend{position:absolute;right:10px;top:10px;font-size:12px;color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    .flex{display:flex;align-items:center;gap:14px}

    .ring-wrap{width:110px;height:110px;margin-top:6px;position:relative}
    .ring{width:110px;height:110px;display:block}
    .ring-bg{fill:none;stroke:var(--ring);stroke-width:10}
    .ring-fg{fill:none;stroke:var(--humid);stroke-width:10;stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%;stroke-dasharray:339.292;stroke-dashoffset:339.292;transition:stroke-dashoffset .5s ease}
    .ring-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800}
    .ring-center .ring-val{font-size:22px}
    .ring-center .ring-unit{font-size:12px;color:var(--muted);margin-left:4px}

    .bar-wrap{width:100%;height:14px;background:var(--bar-bg);border-radius:6px;overflow:hidden;margin-top:6px}
    .bar-fill{height:100%;background:var(--bar-fill);width:0%;transition:width .5s ease}
  </style>
</head>
<body>
  <div class="shell">
    <div class="panel-sizer">
      <div class="panel">
        <header>
          <div>
            <div class="title">GI√ÅM S√ÅT V√Ä PH√ÇN T√çCH CH·ªà S·ªê TRONG ƒê·∫§T</div>
            <div class="sub" id="subtitle">Ngu·ªìn d·ªØ li·ªáu: demo c·ª•c b·ªô</div>
          </div>
          <div class="controls">
            <span class="pill"><span class="status-dot" id="connDot"></span><span id="connText">ƒêang ch·∫°y</span></span>
            <span class="pill" id="modeText">Ch·∫ø ƒë·ªô: AUTO</span>
            <button id="refreshBtn" class="btn secondary">‚Üª L√†m m·ªõi</button>
          </div>
        </header>

        <section class="grid">
          <!-- C√°c card c·ªßa b·∫°n gi·ªØ nguy√™n -->
          <div class="card" data-key="soilTemp"><div class="label"><span class="icon">üå°Ô∏è</span> Nhi·ªát ƒë·ªô trong ƒë·∫•t</div><div class="value"><span class="val">--</span><span class="unit">¬∞C</span></div><div class="trend" data-trend></div></div>
          <div class="card" data-key="soilMoisture"><div class="label"><span class="icon">üíß</span> ƒê·ªô ·∫©m trong ƒë·∫•t</div><div class="flex"><div class="ring-wrap"><svg class="ring" viewBox="0 0 120 120"><circle class="ring-bg" cx="60" cy="60" r="54"></circle><circle class="ring-fg" cx="60" cy="60" r="54"></circle></svg><div class="ring-center"><span class="ring-val">--</span><span class="ring-unit">%</span></div></div><div class="value" style="margin:0"><span class="val">--</span><span class="unit">%</span></div></div><div class="trend" data-trend></div></div>
          <!-- ... c√°c card kh√°c ... -->
        </section>
      </div>
    </div>
  </div>

  <!-- Era SDK -->
  <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.6/src/index.js"></script>
  <script>
    const fields=['soilTemp','soilMoisture','soilPH','soilEC','phosphorus','nitrogen','potassium','airTemp','airHumidity'];
    const units={soilTemp:'¬∞C',soilMoisture:'%',soilPH:'pH',soilEC:'mS/cm',phosphorus:'mg/kg',nitrogen:'mg/kg',potassium:'mg/kg',airTemp:'¬∞C',airHumidity:'%'};
    const CIRCUM=339.292; let last={};

    const clamp01=x=>Math.max(0,Math.min(1,x));
    function updateRing(card,percent){
      const fg=card.querySelector('.ring-fg'); const txt=card.querySelector('.ring-val');
      if(!fg||!txt) return;
      const p=isFinite(percent)?Math.round(percent):0;
      const t=clamp01(p/100);
      fg.style.strokeDashoffset=String(CIRCUM*(1-t));
      txt.textContent=isFinite(percent)?p:'--';
    }
    function updateBar(card,val,max){
      const bar=card.querySelector('.bar-fill'); if(!bar) return;
      const percent=clamp01(val/max)*100; bar.style.width=percent+'%';
    }
    function updateCard(k,v){
      const c=document.querySelector(`[data-key="${k}"]`); if(!c) return;
      const ve=c.querySelector('.val'); const te=c.querySelector('[data-trend]'); const prev=last[k];
      ve.textContent=(v??'--'); if(units[k]) c.querySelector('.unit').textContent=units[k];
      if(typeof prev==='number'&&typeof v==='number'){
        const d=Math.round((v-prev)*100)/100;
        te.textContent=d===0?'‚Äî':(d>0?`‚Üë +${d}`:`‚Üì ${d}`);
        te.style.color=d>0?'var(--ok)':'var(--warn)';
      }
      last[k]=typeof v==='number'?v:prev;
      if(k==='soilMoisture'||k==='airHumidity') updateRing(c,Number(v));
      if(['phosphorus','nitrogen','potassium'].includes(k)) updateBar(c,Number(v),200);
      if(k==='soilPH') updateBar(c,Number(v),14);
    }
    function applyPayload(p){ fields.forEach(k=>{ if(p&&p[k]!==undefined) updateCard(k,p[k]); }); }

    eraWidget.init({
      ready:false,
      needRealtimeConfigs:true,
      needHistoryConfigs:true,
      needActions:true,
      maxRealtimeConfigsCount:12,
      maxHistoryConfigsCount:12,
      maxActionsCount:2,
      mobileHeight:520,
      onConfiguration:(cfg)=>{ requestAnimationFrame(applyScaleAndResize); },
      onValues:(values={})=>{ applyPayload(values); requestAnimationFrame(applyScaleAndResize); },
    });
    eraWidget.ready();

    /* === Scale 4 c·ªôt an to√†n === */
    const DESIGN_WIDTH = 1180;
    function safeNumber(x,f=0){ return Number.isFinite(x)?x:f; }
    function applyScaleAndResize(){
      const shell=document.querySelector('.shell');
      const panel=document.querySelector('.panel');
      const sizer=document.querySelector('.panel-sizer');
      if(!shell||!panel||!sizer) return;
      const cs=getComputedStyle(shell);
      const padH=(parseFloat(cs.paddingLeft)||0)+(parseFloat(cs.paddingRight)||0);
      const vw=document.documentElement.clientWidth;
      if(!vw||vw<=0){ requestAnimationFrame(applyScaleAndResize); return; }
      const raw=(vw-padH-1)/DESIGN_WIDTH;
      let scale=Math.min(1,Math.max(0.3,safeNumber(raw,1)));
      const naturalHeight=panel.scrollHeight||panel.offsetHeight;
      if(!naturalHeight||naturalHeight<10){ requestAnimationFrame(applyScaleAndResize); return; }
      panel.style.transform=`scale(${scale}) translateZ(0)`;
      const scaledHeight=Math.ceil(naturalHeight*scale);
      sizer.style.height=scaledHeight+'px';
      try{ eraWidget.requestAdjustMobileHeight(scaledHeight); }catch(e){}
    }
    ['load','resize','orientationchange'].forEach(ev=>
      window.addEventListener(ev,()=>requestAnimationFrame(applyScaleAndResize),{passive:true})
    );
    document.addEventListener('DOMContentLoaded',()=>{requestAnimationFrame(()=>requestAnimationFrame(applyScaleAndResize));});
  </script>
</body>
</html>

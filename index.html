<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>IFrame b·∫£ng ƒëi·ªÅu khi·ªÉn t∆∞·ªõi c√¢y</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827ee; --text:#e5e7eb; --muted:#94a3b8;
      --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444; --ok:#60a5fa; --ring:#1f2937;
      --humid:#22c55e; --bar-bg:#1e293b; --bar-fill:#60a5fa;
    }
    [data-theme="light"]{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#475569;--accent:#16a34a;--ring:#e2e8f0;--bar-bg:#e2e8f0;--bar-fill:#2563eb}
    *{box-sizing:border-box}

    /* TRANG CON: n·ªÅn trong su·ªët ƒë·ªÉ h√≤a n·ªÅn app E-Ra */
    html, body { margin:0; padding:0; width:100%; min-height:100%; overflow-x:hidden; }
    body { background: transparent; font-family:system-ui, Segoe UI, Roboto; color:var(--text); }

    /* V·ªé NGO√ÄI + PANEL */
    .shell{
      max-width:1180px;
      margin:0 auto;
      padding-top:max(12px, env(safe-area-inset-top));
      padding-bottom:max(12px, env(safe-area-inset-bottom));
      padding-left:max(12px, env(safe-area-inset-left));
      padding-right:max(12px, env(safe-area-inset-right));
    }

    /* Sizer ƒë·ª° chi·ªÅu cao sau khi scale (transform kh√¥ng ƒë·∫©y layout) */
    .panel-sizer{ position:relative; height:auto; }

    /* Panel thi·∫øt k·∫ø theo b·ªÅ r·ªông desktop r·ªìi scale xu·ªëng mobile */
    .panel{
      width:1180px;                 /* DESKTOP DESIGN WIDTH ‚Äî ch·ªânh tu·ª≥ √Ω (1024/1180/1280) */
      margin:0 auto;
      background:#0b1220;
      border:1px solid var(--ring);
      border-radius:16px;
      padding:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
      transform-origin: top center; /* quan tr·ªçng ƒë·ªÉ scale ƒë·∫πp t·ª´ tr√™n xu·ªëng */
    }

    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:4px 4px 0}
    .title{font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--ring);font-size:12px;color:var(--muted)}
    .status-dot{width:8px;height:8px;border-radius:999px;background:var(--accent)}
    button{appearance:none;border:none;cursor:pointer;padding:10px 14px;border-radius:10px;font-weight:600}
    .btn{background:var(--ok);color:#0b1220}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--ring)}
    .btn.danger{background:var(--danger);color:#fff}

    /* LU√îN 4 C·ªòT (desktop & mobile), kh√¥ng d√πng media query ƒë·ªïi c·ªôt */
    .grid{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}

    .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:14px;position:relative;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.15)}
    .label{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;display:flex;align-items:center;gap:8px}
    .label .icon{font-size:20px}
    .value{font-size:22px;font-weight:700;margin-top:8px;display:flex;align-items:baseline}
    .unit{font-size:14px;color:var(--muted);margin-left:6px}
    .trend{position:absolute;right:10px;top:10px;font-size:12px;color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    .flex{display:flex;align-items:center;gap:14px}

    /* Ring 0‚Äì100% */
    .ring-wrap{width:110px;height:110px;margin-top:6px;position:relative}
    .ring{width:110px;height:110px;display:block}
    .ring-bg{fill:none;stroke:var(--ring);stroke-width:10}
    .ring-fg{fill:none;stroke:var(--humid);stroke-width:10;stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%;stroke-dasharray:339.292;stroke-dashoffset:339.292;transition:stroke-dashoffset .5s ease}
    .ring-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800}
    .ring-center .ring-val{font-size:22px}
    .ring-center .ring-unit{font-size:12px;color:var(--muted);margin-left:4px}

    /* Progress bar */
    .bar-wrap{width:100%;height:14px;background:var(--bar-bg);border-radius:6px;overflow:hidden;margin-top:6px}
    .bar-fill{height:100%;background:var(--bar-fill);width:0%;transition:width .5s ease}

    /* scale text nh·ªè theo viewport (nh·∫π nh√†ng) */
    .label{font-size:clamp(11px,2.2vw,13px)}
    .label .icon{font-size:clamp(18px,3.8vw,20px)}
    .value{font-size:clamp(18px,4vw,22px)}
    button{padding:clamp(8px,1.8vw,10px) clamp(10px,2.2vw,14px)}
    .ring-wrap,.ring{width:110px;height:110px}
    @media(max-width:700px){.ring-wrap,.ring{width:96px;height:96px}}
    @media(max-width:480px){.ring-wrap,.ring{width:84px;height:84px}}
    @media(max-width:360px){.ring-wrap,.ring{width:72px;height:72px}}
  </style>
</head>
<body>
  <div class="shell">
    <div class="panel-sizer"><!-- JS s·∫Ω set height th·ª±c t·∫ø sau khi scale -->
      <div class="panel">
        <header>
          <div>
            <div class="title">GI√ÅM S√ÅT V√Ä PH√ÇN T√çCH CH·ªà S·ªê TRONG ƒê·∫§T</div>
            <div class="sub" id="subtitle">Ngu·ªìn d·ªØ li·ªáu: demo c·ª•c b·ªô</div>
          </div>
          <div class="controls">
            <span class="pill"><span class="status-dot" id="connDot"></span><span id="connText">ƒêang ch·∫°y</span></span>
            <span class="pill" id="modeText">Ch·∫ø ƒë·ªô: AUTO</span>
            <button id="refreshBtn" class="btn secondary">‚Üª L√†m m·ªõi</button>
          </div>
        </header>

        <section class="grid">
          <div class="card" data-key="soilTemp">
            <div class="label"><span class="icon">üå°Ô∏è</span> Nhi·ªát ƒë·ªô trong ƒë·∫•t</div>
            <div class="value"><span class="val">--</span><span class="unit">¬∞C</span></div>
            <div class="trend" data-trend></div>
          </div>

          <div class="card" data-key="soilMoisture">
            <div class="label"><span class="icon">üíß</span> ƒê·ªô ·∫©m trong ƒë·∫•t</div>
            <div class="flex">
              <div class="ring-wrap">
                <svg class="ring" viewBox="0 0 120 120">
                  <circle class="ring-bg" cx="60" cy="60" r="54"></circle>
                  <circle class="ring-fg" cx="60" cy="60" r="54"></circle>
                </svg>
                <div class="ring-center"><span class="ring-val">--</span><span class="ring-unit">%</span></div>
              </div>
              <div class="value" style="margin:0"><span class="val">--</span><span class="unit">%</span></div>
            </div>
            <div class="trend" data-trend></div>
          </div>

          <div class="card" data-key="soilPH">
            <div class="label"><span class="icon">‚öóÔ∏è</span> ƒê·ªô pH</div>
            <div class="value"><span class="val">--</span><span class="unit">pH</span></div>
            <div class="bar-wrap"><div class="bar-fill"></div></div>
            <div class="trend" data-trend></div>
          </div>

          <div class="card" data-key="soilEC">
            <div class="label"><span class="icon">üîå</span> ƒê·ªô d·∫´n ƒëi·ªán DC</div>
            <div class="value"><span class="val">--</span><span class="unit">mS/cm</span></div>
            <div class="trend" data-trend></div>
          </div>

          <div class="card" data-key="phosphorus">
            <div class="label"><span class="icon">üü£</span> Photpho (P)</div>
            <div class="value"><span class="val">--</span><span class="unit">mg/kg</span></div>
            <div class="bar-wrap"><div class="bar-fill"></div></div>
            <div class="trend" data-trend></div>
          </div>

          <div class="card" data-key="nitrogen">
            <div class="label"><span class="icon">üü¢</span> Nito (N)</div>
            <div class="value"><span class="val">--</span><span class="unit">mg/kg</span></div>
            <div class="bar-wrap"><div class="bar-fill"></div></div>
            <div class="trend" data-trend></div>
          </div>

          <div class="card" data-key="potassium">
            <div class="label"><span class="icon">üü°</span> Kali (K)</div>
            <div class="value"><span class="val">--</span><span class="unit">mg/kg</span></div>
            <div class="bar-wrap"><div class="bar-fill"></div></div>
            <div class="trend" data-trend></div>
          </div>

          <div class="card" data-key="airTemp">
            <div class="label"><span class="icon">üå§Ô∏è</span> Nhi·ªát ƒë·ªô kh√¥ng kh√≠</div>
            <div class="value"><span class="val">--</span><span class="unit">¬∞C</span></div>
            <div class="trend" data-trend></div>
          </div>

          <div class="card" data-key="airHumidity">
            <div class="label"><span class="icon">‚òÅÔ∏è</span> ƒê·ªô ·∫©m kh√¥ng kh√≠</div>
            <div class="flex">
              <div class="ring-wrap">
                <svg class="ring" viewBox="0 0 120 120">
                  <circle class="ring-bg" cx="60" cy="60" r="54"></circle>
                  <circle class="ring-fg" cx="60" cy="60" r="54"></circle>
                </svg>
                <div class="ring-center"><span class="ring-val">--</span><span class="ring-unit">%</span></div>
              </div>
              <div class="value" style="margin:0"><span class="val">--</span><span class="unit">%</span></div>
            </div>
            <div class="trend" data-trend></div>
          </div>

          <div class="card" id="irrigationCard">
            <div class="label"><span class="icon">üöø</span> ƒêi·ªÅu khi·ªÉn t∆∞·ªõi c√¢y</div>
            <div class="value" id="irrigationState">Tr·∫°ng th√°i: <strong>T·∫ÆT</strong></div>
            <div class="controls" style="margin-top:8px">
              <button class="btn" id="toggleIrrigation">B·∫≠t t∆∞·ªõi</button>
              <button class="btn secondary" id="pulseIrrigation">Nh√°y t∆∞·ªõi 10s</button>
              <button class="btn danger" id="stopIrrigation">T·∫Øt t∆∞·ªõi</button>
            </div>
            <div class="small" id="lastAction">‚Äî</div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Era SDK: global window.eraWidget -->
  <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.6/src/index.js"></script>
  <script>
    const fields=['soilTemp','soilMoisture','soilPH','soilEC','phosphorus','nitrogen','potassium','airTemp','airHumidity'];
    const units={soilTemp:'¬∞C',soilMoisture:'%',soilPH:'pH',soilEC:'mS/cm',phosphorus:'mg/kg',nitrogen:'mg/kg',potassium:'mg/kg',airTemp:'¬∞C',airHumidity:'%'};
    const CIRCUM=339.292;
    let last={};

    const clamp01=x=>Math.max(0,Math.min(1,x));
    function updateRing(card,percent){
      const fg=card.querySelector('.ring-fg'); const txt=card.querySelector('.ring-val');
      if(!fg||!txt) return;
      const p=isFinite(percent)?Math.round(percent):0;
      const t=clamp01(p/100);
      fg.style.strokeDashoffset=String(CIRCUM*(1-t));
      txt.textContent=isFinite(percent)?p:'--';
    }
    function updateBar(card,val,max){
      const bar=card.querySelector('.bar-fill'); if(!bar) return;
      const percent=clamp01(val/max)*100; bar.style.width=percent+'%';
    }
    function updateCard(k,v){
      const c=document.querySelector(`[data-key="${k}"]`); if(!c) return;
      const ve=c.querySelector('.val'); const te=c.querySelector('[data-trend]'); const prev=last[k];
      ve.textContent=(v??'--'); if(units[k]) c.querySelector('.unit').textContent=units[k];
      if(typeof prev==='number'&&typeof v==='number'){
        const d=Math.round((v-prev)*100)/100;
        te.textContent=d===0?'‚Äî':(d>0?`‚Üë +${d}`:`‚Üì ${d}`);
        te.style.color=d>0?'var(--ok)':'var(--warn)';
      }
      last[k]=typeof v==='number'?v:prev;
      if(k==='soilMoisture'||k==='airHumidity') updateRing(c,Number(v));
      if(['phosphorus','nitrogen','potassium'].includes(k)) updateBar(c,Number(v),200);
      if(k==='soilPH') updateBar(c,Number(v),14);
    }
    function applyPayload(p){
      fields.forEach(k=>{ if(p&&p[k]!==undefined) updateCard(k,p[k]); });
      if(p&&typeof p.irrigationOn==='boolean') setIrrigationState(p.irrigationOn);
    }

    const irrigationStateEl=document.getElementById('irrigationState');
    const lastActionEl=document.getElementById('lastAction');
    let irrigationOn=false;
    function setIrrigationState(on){
      irrigationOn=!!on;
      irrigationStateEl.innerHTML=`Tr·∫°ng th√°i: <strong>${on?'B·∫¨T':'T·∫ÆT'}</strong>`;
      document.getElementById('toggleIrrigation').textContent=on?'T·∫Øt t∆∞·ªõi':'B·∫≠t t∆∞·ªõi';
    }
    document.getElementById('toggleIrrigation').onclick=()=>{ setIrrigationState(!irrigationOn); lastActionEl.textContent='ƒê·ªïi tr·∫°ng th√°i'; };
    document.getElementById('pulseIrrigation').onclick=()=>{ lastActionEl.textContent='Nh√°y t∆∞·ªõi 10s'; };
    document.getElementById('stopIrrigation').onclick=()=>{ setIrrigationState(false); lastActionEl.textContent='D·ª´ng t∆∞·ªõi'; };

    /* ===== ERA WIDGET ===== */
    let configsoilTemp=null, configsoilMoisture=null, configsoilPH=null, configsoilEC=null,
        configphosphorus=null, confignitrogen=null, configpotassium=null, configairTemp=null, configairHumidity=null,
        actions=[];

    const pick=(cfg,values)=>{
      if(!cfg||!cfg.id) return undefined;
      const slot=values[cfg.id]; if(!slot) return undefined;
      let v=slot.value; if(typeof v==='string'&&v.trim()!==''&&!isNaN(Number(v))) v=Number(v);
      return v;
    };

    eraWidget.init({
      ready:false,
      needRealtimeConfigs:true,
      needHistoryConfigs:true,
      needActions:true,
      maxRealtimeConfigsCount:12,
      maxHistoryConfigsCount:12,
      maxActionsCount:2,

      /* Chi·ªÅu cao ban ƒë·∫ßu cho mobile app ‚Äî s·∫Ω ƒë∆∞·ª£c update ƒë·ªông khi scale */
      mobileHeight: 520,

      onConfiguration:(configuration)=>{
        const rc=configuration.realtime_configs||[];
        configsoilTemp    = rc[0]; configsoilMoisture=rc[1]; configsoilPH=rc[2]; configsoilEC=rc[3];
        configphosphorus  = rc[4]; confignitrogen   = rc[5]; configpotassium=rc[6];
        configairTemp     = rc[7]; configairHumidity=rc[8];
        actions=configuration.actions||[];
        if(configuration.url){ document.getElementById('subtitle').textContent=`Ngu·ªìn d·ªØ li·ªáu: ${configuration.url}`; }
        requestAnimationFrame(applyScaleAndResize);
      },
      onValues:(values={})=>{
        const payload={
          soilTemp:pick(configsoilTemp,values), soilMoisture:pick(configsoilMoisture,values),
          soilPH:pick(configsoilPH,values), soilEC:pick(configsoilEC,values),
          phosphorus:pick(configphosphorus,values), nitrogen:pick(confignitrogen,values),
          potassium:pick(configpotassium,values), airTemp:pick(configairTemp,values),
          airHumidity:pick(configairHumidity,values)
        };
        applyPayload(payload);
        requestAnimationFrame(applyScaleAndResize);  // re-scale khi n·ªôi dung thay ƒë·ªïi
      },
    });
    eraWidget.ready();

    /* ===== Gi·ªØ 4 c·ªôt tr√™n mobile: scale panel ƒë·ªÉ v·ª´a chi·ªÅu ngang ===== */
    const DESIGN_WIDTH = 1180; // kh·ªõp v·ªõi .panel{width:1180px}
    function applyScaleAndResize(){
      const shell = document.querySelector('.shell');
      const panel = document.querySelector('.panel');
      const sizer = document.querySelector('.panel-sizer');
      if (!shell || !panel || !sizer) return;

      const cs = getComputedStyle(shell);
      const padH = parseFloat(cs.paddingLeft) + parseFloat(cs.paddingRight);
      const vw = document.documentElement.clientWidth;

      // scale = (b·ªÅ r·ªông kh·∫£ d·ª•ng) / DESIGN_WIDTH, t·ªëi ƒëa 1 (kh√¥ng ph√≥ng to)
      const scale = Math.min(1, (vw - padH) / DESIGN_WIDTH);

      // √Åp scale cho panel
      panel.style.transform = `scale(${scale})`;

      // T√≠nh chi·ªÅu cao hi·ªÉn th·ªã sau khi scale ƒë·ªÉ wrapper ‚Äúƒë·ª°‚Äù layout
      const scaledHeight = Math.ceil(panel.offsetHeight * scale);
      sizer.style.height = scaledHeight + 'px';

      // B√°o cho app E-Ra n·ªõi chi·ªÅu cao iFrame
      try { eraWidget.requestAdjustMobileHeight(scaledHeight); } catch(e) {}
    }

    // G·ªçi khi load/resize/orientation, ƒë·∫£m b·∫£o m∆∞·ª£t
    ['load','resize','orientationchange'].forEach(ev =>
      window.addEventListener(ev, () => requestAnimationFrame(applyScaleAndResize), {passive:true})
    );
    // L·∫ßn ƒë·∫ßu
    applyScaleAndResize();
  </script>
</body>
</html>
